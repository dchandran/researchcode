<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>EaselJS: Protein Chomp</title>

	<script src="../third-party/easeljs/easeljs-NEXT.combined.js"></script>
	<script src="generic_functions.js"></script>
	
<script id="editable">	
	var stage;

	var lipid_bilayer = createAnimModule("lipid bilayer");
	var dna_template = createAnimModule("dna template");
	var two_component = createAnimModule("two component");
	var sbol_parts = createAnimModule("sbol parts");

	lipid_bilayer.init = function(stage, scene) {
		var bilayerSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["bilayer.png"],
				"frames": {"regX": 0, "height": 53, "count": 1, "regY": 0, "width": 9},
				"animations": {
					"normal": 0
				}
			});

		var bilayer;
		for (var i=0; i <= scene.width; i = i + 9) {
			bilayer = new createjs.Sprite(bilayerSheet, "normal");
			bilayer.x = i;
			bilayer.y = 100;
			stage.addChild(bilayer);
		}
	};	

	dna_template.init = function(stage, scene) {
		var dnaSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["DNA.png"],
				"frames": {"regX": 0, "height": 50, "count": 1, "regY": 0, "width": 90},
				"animations": {
					"normal": 0
				}
			});

		var dnaStrand;
		for (i=0; i <= scene.width; i = i + 90*0.3) {
			dnaStrand = new createjs.Sprite(dnaSheet, "normal");
			dnaStrand.x = scene.left + i;
			dnaStrand.y = scene.top + scene.height*0.5;
			dnaStrand.scaleY = 0.3;
			dnaStrand.scaleX = 0.3;
			stage.addChild(dnaStrand);
		}
	};

	two_component.init = function(stage, scene) {
		var i;

		this.proteinChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["protein_chomp.png"],
				"frames": {"regX": 0, "height": 51, "count": 17, "regY": 0, "width": 65},
				// define two animations, run (loops, 1.5x speed) and jump (returns to run):
				"animations": {
					"active": [0, 15, "active", 0.5],
					"bind": [0, 8, "bound", 0.7],
					"bound": 8,
					"inert": 16,
				}
			});

		this.membraneChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["membrane_protein_chomp.png"],
				"frames": {"regX": 0, "height": 120, "count": 11, "regY": 0, "width": 50},				
				"animations": {
					"active": [0, 9, "active", 0.5],
					"inert": 10
				}
			});

		this.n = 5;
		this.receptors = [];
		receptors = this.receptors;
		var recp;
		for (i=0; i < n; ++i) {
			recp = new createjs.Sprite(membraneChompSheet, "inert", false);
			initDiffusableMolecule(recp, {left: scene.left, width: scene.width, height: 0, top: scene.top+70}, false)
			recp.x = recp.bounds.left + recp.bounds.width*(Math.random());
			recp.y = recp.bounds.top + recp.bounds.height*(Math.random());
			recp.scaleX = recp.scaleY = 1;
			recp.velY = 0;
			recp.velTheta = 0;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(recp);
			receptors.push(recp);
		}

		n = 20;
		this.tfs = [];
		var tfs = this.tfs;
		var tf;
		for (i=0; i < n; ++i) {
			tf = new createjs.Sprite(proteinChompSheet, "inert");
			initDiffusableMolecule(tf, {left: scene.left, width: scene.width, height: scene.height/4, top: scene.top+240});
			tf.x = tf.bounds.left + tf.bounds.width*(Math.random());
			tf.y = tf.bounds.top + tf.bounds.height*(Math.random());
			tf.scaleX = tf.scaleY = 1;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(tf);			
			tfs.push(tf);
		}
	};

	two_component.tick = function(event) {
		var tf, rec, recp;
		var percentActiveTFs = parameters.two_component.percentActiveMembranes;

		for (var i=0; i < receptors.length; ++i) {
			rec = receptors[i];

			if (rec.currentAnimation !== 'active' && i < parameters.two_component.percentActiveMembranes*receptors.length) {
				rec.gotoAndPlay('active');
			}

			moveDiffusableMolecule(rec);
		}

		for (var i=0; i < tfs.length; ++i) {
			tf = tfs[i];

			if (tf.currentAnimation !== 'active' && i < percentActiveTFs*tfs.length) {
				tf.gotoAndPlay('active');
				tf.velX *= 3;
				tf.velY *= 3;
				tf.bounds.height = scene.height;
			}

			moveDiffusableMolecule(tf);
		}
	};

	sbol_parts.init = function(stage, scene) {

		sbol_parts.partTypeSpriteHash = {
			'promoter': new createjs.SpriteSheet({
							framerate: 30,
							"images": ["SBOL/promoter.png"],
							"frames": {"regX": 0, "height": 220, "count": 2, "regY": 0, "width": 170},
							"animations": {
								"off": 0,
								"on": 1
							}
						}),
			'cds': 		new createjs.SpriteSheet({
							framerate: 30,
							"images": ["SBOL/CDS.png"],
							"frames": {"regX": 0, "height": 101, "count": 2, "regY": 0, "width": 225},
							"animations": {
								"off": 0,
								"on": 1
							}
						})
		};

		this.parts = [];
	};

	sbol_parts.tick = function(event) {
		var part, desc, i, sheet, x=scene.left + 100;
		var partDesc = this.inputs.parts; //e.g. { p: {type:'promoter', state:'off'}, gfp:{type:'cds', state:'off'} }
		var partTypeSpriteHash = this.partTypeSpriteHash;
		var parts = this.parts;

		if (partDesc) {
			for (i in partDesc) {
				desc = partDesc[i];
				if (desc) {	
					part = parts[i];
					if (part) {
						state = desc.state;
						if (state)
							part.gotoAndPlay(state);
					} else {
						sheet = partTypeSpriteHash[desc.type];
						state = desc.state;
						if (sheet && state) {
							part = 	new createjs.Sprite(sheet, state);								
							part.scaleY = part.scaleX = 0.3;
							stage.addChild(part);
							parts[i] = part;
						}
					}
					part.x = x;
					x = x + part.getBounds().width * 0.3;
					part.y = scene.top + scene.height*0.5 - part.getBounds().height*0.3;
				}
			}
		}

		this.location.x = x - 100;
	};

	protein_bursts.init = function(stage, scene) {
		this.mrnaSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["mrna_wiggle.png"],
				"frames": {"regX": 0, "height": 26, "count": 10, "regY": 0, "width": 100},
				"animations": {
					"wiggle": [0, 9, "wiggle", 0.3]
				}
			});

		this.protSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["protein_green_grey.png"],
				"frames": {"regX": 0, "height": 50, "count": 10, "regY": 0, "width": 60.5},
				"animations": {
					"grey": [0,0,"green", 0.02],
					"green": 1
				}
			});

		this.mrnas = [];
		this.existingProts = [];
		this.newProts = [];		
	};

	protein_bursts.tick = function(event) {
		var mrnas = this.mrnas;
		var existingProts = this.existingProts;
		var newProts = this.newProts;
		var mrna;
		var prot;
		var delayRNA = 26, delayProt = 11;
		var location = parameters.protein_bursts.location;
		if (!location) return;

		if (mrnas.length < parameters.protein_bursts.burstRNA && delayRNA > 25) {
			mrna = new createjs.Sprite(mrnaSheet, "wiggle");
			mrna.x = location.x + Math.random()*20;
			mrna.y = location.y
			mrna.scaleY = 1;
			mrna.scaleX = 1;
			stage.addChild(mrna);
			mrnas.push(mrna);
			delayRNA = 0;
		}

		if (mrnas.length > 3 && newProts.length < parameters.protein_bursts.burstProt && delayProt > 10) {
			prot = new createjs.Sprite(protSheet, "grey");
			prot.x = mrnas[mrnas.length-1].x + 5;
			prot.y = mrnas[mrnas.length-1].y;
			prot.scaleY = 1;
			prot.scaleX = 1;
			stage.addChild(prot);
			newProts.push(prot);
			delayProt = 0;

			initDiffusableMolecule(prot, scene);
		}

		delayRNA = delayRNA + 1;
		delayProt = delayProt + 1;
		var allRNADead = true;

		for (i=0; i < mrnas.length; ++i) {

			if (mrnas[i]) {
				allRNADead = false;
				mrnas[i].x = mrnas[i].x + (Math.random()-0.5) * 4;
				mrnas[i].y = mrnas[i].y - Math.random() * 2;

				if (mrnas[i].y < scene.top + scene.height*0.6) {

					mrnas[i].alpha = 0.5;

					if (mrnas[i].y < scene.top + scene.height*0.10) {
						stage.removeChild(mrnas[i]);
						mrnas[i] = undefined;
					}
				}
			}

		}

		if (allRNADead && mrnas.length > 0) {
			mrnas.length = 0;
			existingProts = existingProts.concat(newProts);
			newProts.length = 0;
			parameters.protein_bursts.burstRNA = 0;
			delayRNA = 11;
			delayProt = 6;
		}

		for (i=0; i < existingProts.length; ++i) {
			moveDiffusableMolecule(existingProts[i]);
		}

		for (i=0; i < newProts.length; ++i) {
			moveDiffusableMolecule(newProts[i]);
		}
	};

	function init() {

		// create a new stage and point it at our canvas:
		stage = new createjs.Stage(document.getElementById("testCanvas"));
		var rect1 = {left:0, top:0, width: stage.canvas.width, height: stage.canvas.height};
		var rect2 = {left:0, top:stage.canvas.width/2, width: stage.canvas.width, height: stage.canvas.height/2};

		//parameters
		parameters.two_component = {percentActiveMembranes: 0};
		parameters.protein_bursts = {burstRNA:0, burstProt:0, location:{x:0,y:(rect2.top + rect2.height/2)}};
		parameters.sbol = { left: 100 };

		createjs.Ticker.timingMode = createjs.Ticker.RAF;
		createjs.Ticker.addEventListener("tick", stage);

		var modules = [
			lipid_bilayer(stage, rect1),
			dna_template(stage, rect2),
			two_component(stage, rect1),
			protein_bursts(stage, rect1),
			sbol_parts(stage, rect2)
		];

		for (var i=0; i < modules.length; ++i) {
			if (modules[i]) {
				createjs.Ticker.addEventListener("tick", modules[i].tick);
			}
		}

		
	}

</script>
</head>

<body onload="init();">

<div>
	<canvas id="testCanvas" width="1000" height="800"></canvas>
</div>
</body>
</html>
