<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>EaselJS: Protein Chomp</title>

	<script src="../third-party/easeljs/easeljs-NEXT.combined.js"></script>
	<!-- We also provide hosted minified versions of all CreateJS libraries.
	  http://code.createjs.com -->

<script id="editable">
	var stage;
	var percentActiveMembranes = 0.0;

	function initDiffusableMolecule(m, bounds, rotate) {
		if (rotate===undefined) {
			rotate = true;
		}

		if (rotate) {
			m.rotation = 360*Math.random();
		}

		m.allowRotation = rotate;
		m.velX = 0.7*(Math.random() - 0.5);
		m.velY = 0.7*(Math.random() - 0.5);
		m.velTheta = (Math.random() - 0.5);
		m.bounds = bounds;
	}

	function moveDiffusableMolecule(m) {
		m.x = m.x + m.velX;
		m.y = m.y + m.velY;
		var right = m.bounds.left + m.bounds.width;
		var bottom = m.bounds.top + m.bounds.height;

		if (m.x > right) {
			m.x = right;
			m.velX = - m.velX;
		}
		if (m.x < m.bounds.left) {
			m.x = m.bounds.left;
			m.velX = - m.velX;
		}
		if (m.y < m.bounds.top) {
			m.y = m.bounds.top;
			m.velY = - m.velY;
		}
		if (m.y > bottom) {
			m.y = bottom;
			m.velY = - m.velY;
		}

		if (m.allowRotation) {
			m.rotation = m.rotation + m.velTheta;
			if (m.rotation < 0) m.rotation = 360;
			if (m.rotation > 360) m.rotation = 0;

			if (Math.random() < 0.01) {
				m.velTheta = Math.random() - 0.5;
			}
		}
	}

	function init() {

		// create a new stage and point it at our canvas:
		stage = new createjs.Stage(document.getElementById("testCanvas"));
		var scene = {left:0, top:0, width: stage.canvas.width, height: stage.canvas.height};
		
		var bilayerSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["bilayer.png"],
				"frames": {"regX": 0, "height": 53, "count": 1, "regY": 0, "width": 9},
				"animations": {
					"normal": 0
				}
			});

		var bilayer;
		for (var i=0; i <= scene.width; i = i + 9) {
			bilayer = new createjs.Sprite(bilayerSheet, "normal");
			bilayer.x = i;
			bilayer.y = 100;
			stage.addChild(bilayer);
		}

		var proteinChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["protein_chomp.png"],
				"frames": {"regX": 0, "height": 51, "count": 17, "regY": 0, "width": 65},
				// define two animations, run (loops, 1.5x speed) and jump (returns to run):
				"animations": {
					"active": [0, 15, "active", 0.5],
					"bind": [0, 8, "bound", 0.7],
					"bound": 8,
					"inert": 16,
				}
			});

		var membraneChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["membrane_protein_chomp.png"],
				"frames": {"regX": 0, "height": 120, "count": 11, "regY": 0, "width": 50},				
				"animations": {
					"active": [0, 9, "active", 0.5],
					"inert": 10
				}
			});

		var n = 5;
		var receptors = [];
		var recp;
		for (var i=0; i < n; ++i) {
			recp = new createjs.Sprite(membraneChompSheet, "inert", false);
			initDiffusableMolecule(recp, {left: 0, width: scene.width, height: 0, top: 70}, false)
			recp.x = recp.bounds.left + recp.bounds.width*(Math.random());
			recp.y = recp.bounds.top + recp.bounds.height*(Math.random());
			recp.scaleX = recp.scaleY = 1;
			recp.velY = 0;
			recp.velTheta = 0;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(recp);
			receptors.push(recp);
		}

		n = 20;
		var tfs = [];
		var tf;
		for (var i=0; i < n; ++i) {
			tf = new createjs.Sprite(proteinChompSheet, "inert");
			initDiffusableMolecule(tf, {left: 0, width: scene.width, height: 100, top: 200});
			tf.x = tf.bounds.left + tf.bounds.width*(Math.random());
			tf.y = tf.bounds.top + tf.bounds.height*(Math.random());
			tf.scaleX = tf.scaleY = 1;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(tf);			
			tfs.push(tf);
		}

		tick = function(event) {
			var tf, rec;
			var percentActiveTFs = percentActiveMembranes;

			for (var i=0; i < receptors.length; ++i) {
				rec = receptors[i];

				if (rec.currentAnimation !== 'active' && i < percentActiveMembranes*receptors.length) {
					rec.gotoAndPlay('active');
				}

				moveDiffusableMolecule(rec);
			}

			for (var i=0; i < tfs.length; ++i) {
				tf = tfs[i];

				if (tf.currentAnimation !== 'active' && i < percentActiveTFs*tfs.length) {
					tf.gotoAndPlay('active');
					tf.velX *= 3;
					tf.velY *= 3;
					tf.bounds.height = scene.height;
				}

				moveDiffusableMolecule(tf);
			}
		};

		createjs.Ticker.timingMode = createjs.Ticker.RAF;
		createjs.Ticker.addEventListener("tick", stage);
		createjs.Ticker.addEventListener("tick", tick);
	}

</script>
</head>

<body onload="init();">

<div>
	<canvas id="testCanvas" width="800" height="600"></canvas>
</div>
</body>
</html>
