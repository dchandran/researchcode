<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>EaselJS: Protein Chomp</title>

	<script src="../third-party/easeljs/easeljs-NEXT.combined.js"></script>
	
<script id="editable">
	function initDiffusableMolecule(m, bounds, rotate) {
	    if (rotate===undefined) {
	        rotate = true;
	    }

	    if (rotate) {
	        m.rotation = 360*Math.random();
	    }

	    m.allowRotation = rotate;
	    m.velX = 0.7*(Math.random() - 0.5);
	    m.velY = 0.7*(Math.random() - 0.5);
	    m.velTheta = (Math.random() - 0.5);
	    m.bounds = bounds;
	}

	function moveDiffusableMolecule(m) {
	    m.x = m.x + m.velX;
	    m.y = m.y + m.velY;
	    var right = m.bounds.left + m.bounds.width;
	    var bottom = m.bounds.top + m.bounds.height;

	    if (m.x > right) {
	        m.x = right;
	        m.velX = - m.velX;
	    }
	    if (m.x < m.bounds.left) {
	        m.x = m.bounds.left;
	        m.velX = - m.velX;
	    }
	    if (m.y < m.bounds.top) {
	        m.y = m.bounds.top;
	        m.velY = - m.velY;
	    }
	    if (m.y > bottom) {
	        m.y = bottom;
	        m.velY = - m.velY;
	    }

	    if (m.allowRotation) {
	        m.rotation = m.rotation + m.velTheta;
	        if (m.rotation < 0) m.rotation = 360;
	        if (m.rotation > 360) m.rotation = 0;

	        if (Math.random() < 0.01) {
	            m.velTheta = Math.random() - 0.5;
	        }
	    }
	}
	var stage;

	//Module: init(), tick(), input, output

	function lipid_bilayer(stage, scene) {
		var bilayerSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["bilayer.png"],
				"frames": {"regX": 0, "height": 53, "count": 1, "regY": 0, "width": 9},
				"animations": {
					"normal": 0
				}
			});

		var bilayer;
		for (var i=0; i <= scene.width; i = i + 9) {
			bilayer = new createjs.Sprite(bilayerSheet, "normal");
			bilayer.x = i;
			bilayer.y = 100;
			stage.addChild(bilayer);
		}
	}

	function dna_template(stage, scene) {
		var dnaSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["DNA.png"],
				"frames": {"regX": 0, "height": 50, "count": 1, "regY": 0, "width": 90},
				"animations": {
					"normal": 0
				}
			});

		var dnaStrand;
		for (i=0; i <= scene.width; i = i + 90*0.3) {
			dnaStrand = new createjs.Sprite(dnaSheet, "normal");
			dnaStrand.x = scene.left + i;
			dnaStrand.y = scene.top + scene.height*0.5;
			dnaStrand.scaleY = 0.3;
			dnaStrand.scaleX = 0.3;
			stage.addChild(dnaStrand);
		}
	}

	var parameters = {};

	function two_component(stage, scene) {
		var i;

		var proteinChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["protein_chomp.png"],
				"frames": {"regX": 0, "height": 51, "count": 17, "regY": 0, "width": 65},
				// define two animations, run (loops, 1.5x speed) and jump (returns to run):
				"animations": {
					"active": [0, 15, "active", 0.5],
					"bind": [0, 8, "bound", 0.7],
					"bound": 8,
					"inert": 16,
				}
			});

		var membraneChompSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["membrane_protein_chomp.png"],
				"frames": {"regX": 0, "height": 120, "count": 11, "regY": 0, "width": 50},				
				"animations": {
					"active": [0, 9, "active", 0.5],
					"inert": 10
				}
			});

		var n = 5;
		var receptors = [];
		var recp;
		for (i=0; i < n; ++i) {
			recp = new createjs.Sprite(membraneChompSheet, "inert", false);
			initDiffusableMolecule(recp, {left: scene.left, width: scene.width, height: 0, top: scene.top+70}, false)
			recp.x = recp.bounds.left + recp.bounds.width*(Math.random());
			recp.y = recp.bounds.top + recp.bounds.height*(Math.random());
			recp.scaleX = recp.scaleY = 1;
			recp.velY = 0;
			recp.velTheta = 0;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(recp);
			receptors.push(recp);
		}

		n = 20;
		var tfs = [];
		var tf;
		for (i=0; i < n; ++i) {
			tf = new createjs.Sprite(proteinChompSheet, "inert");
			initDiffusableMolecule(tf, {left: scene.left, width: scene.width, height: scene.height/4, top: scene.top+240});
			tf.x = tf.bounds.left + tf.bounds.width*(Math.random());
			tf.y = tf.bounds.top + tf.bounds.height*(Math.random());
			tf.scaleX = tf.scaleY = 1;

			// Add Grant to the stage, and add it as a listener to Ticker to get updates each frame.
			stage.addChild(tf);			
			tfs.push(tf);
		}
		function tick(event) {
			var tf, rec;
			var percentActiveTFs = parameters.two_component.percentActiveMembranes;

			for (var i=0; i < receptors.length; ++i) {
				rec = receptors[i];

				if (rec.currentAnimation !== 'active' && i < parameters.two_component.percentActiveMembranes*receptors.length) {
					rec.gotoAndPlay('active');
				}

				moveDiffusableMolecule(rec);
			}

			for (var i=0; i < tfs.length; ++i) {
				tf = tfs[i];

				if (tf.currentAnimation !== 'active' && i < percentActiveTFs*tfs.length) {
					tf.gotoAndPlay('active');
					tf.velX *= 3;
					tf.velY *= 3;
					tf.bounds.height = scene.height;
				}

				moveDiffusableMolecule(tf);
			}
		}

		return {tick:tick, input:null, output:null};
	}

	function sbol_parts(stage, scene) {

		var partTypeSpriteHash = {
			'promoter': new createjs.SpriteSheet({
							framerate: 30,
							"images": ["SBOL/promoter.png"],
							"frames": {"regX": 0, "height": 220, "count": 2, "regY": 0, "width": 170},
							"animations": {
								"off": 0,
								"on": 1
							}
						}),
			'cds': 		new createjs.SpriteSheet({
							framerate: 30,
							"images": ["SBOL/CDS.png"],
							"frames": {"regX": 0, "height": 101, "count": 2, "regY": 0, "width": 225},
							"animations": {
								"off": 0,
								"on": 1
							}
						})
		};

		var parts = [];		

		function tick(event) {
			var part, desc, i, sheet, x=scene.left + 100;
			var partDesc = parameters.sbol.parts; //e.g. { p: {type:'promoter', state:'off'}, gfp:{type:'cds', state:'off'} }

			if (partDesc) {
				for (i in partDesc) {
					desc = partDesc[i];
					if (desc) {	
						part = parts[i];
						if (part) {
							state = desc.state;
							if (state)
								part.gotoAndPlay(state);
						} else {
							sheet = partTypeSpriteHash[desc.type];
							state = desc.state;
							if (sheet && state) {
								part = 	new createjs.Sprite(sheet, state);								
								part.scaleY = part.scaleX = 0.3;
								stage.addChild(part);
								parts[i] = part;
							}
						}
						part.x = x;
						x = x + part.getBounds().width * 0.3;
						part.y = scene.top + scene.height*0.5 - part.getBounds().height*0.3;
					}
				}
			}

			parameters.protein_bursts.location.x = x - 100;
		}

		return {tick:tick, input:null, output:null};
	}

	function protein_bursts(stage, scene) {
		var mrnaSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["mrna_wiggle.png"],
				"frames": {"regX": 0, "height": 26, "count": 10, "regY": 0, "width": 100},
				"animations": {
					"wiggle": [0, 9, "wiggle", 0.3]
				}
			});

		var protSheet = new createjs.SpriteSheet({
				framerate: 30,
				"images": ["protein_green_grey.png"],
				"frames": {"regX": 0, "height": 50, "count": 10, "regY": 0, "width": 60.5},
				"animations": {
					"grey": [0,0,"green", 0.02],
					"green": 1
				}
			});

		var mrna;
		var prot;
		var mrnas = [];
		var existingProts = [];
		var newProts = [];
		var delayRNA = 26, delayProt = 11;

		function tick(event) {
			var location = parameters.protein_bursts.location;
			if (!location) return;

			if (mrnas.length < parameters.protein_bursts.burstRNA && delayRNA > 25) {
				mrna = new createjs.Sprite(mrnaSheet, "wiggle");
				mrna.x = location.x + Math.random()*20;
				mrna.y = location.y
				mrna.scaleY = 1;
				mrna.scaleX = 1;
				stage.addChild(mrna);
				mrnas.push(mrna);
				delayRNA = 0;
			}

			if (mrnas.length > 3 && newProts.length < parameters.protein_bursts.burstProt && delayProt > 10) {
				prot = new createjs.Sprite(protSheet, "grey");
				prot.x = mrnas[mrnas.length-1].x + 5;
				prot.y = mrnas[mrnas.length-1].y;
				prot.scaleY = 1;
				prot.scaleX = 1;
				stage.addChild(prot);
				newProts.push(prot);
				delayProt = 0;

				initDiffusableMolecule(prot, scene);
			}

			delayRNA = delayRNA + 1;
			delayProt = delayProt + 1;
			var allRNADead = true;

			for (i=0; i < mrnas.length; ++i) {

				if (mrnas[i]) {
					allRNADead = false;
					mrnas[i].x = mrnas[i].x + (Math.random()-0.5) * 4;
					mrnas[i].y = mrnas[i].y - Math.random() * 2;

					if (mrnas[i].y < scene.top + scene.height*0.6) {

						mrnas[i].alpha = 0.5;

						if (mrnas[i].y < scene.top + scene.height*0.10) {
							stage.removeChild(mrnas[i]);
							mrnas[i] = undefined;
						}
					}
				}
			}

			if (allRNADead && mrnas.length > 0) {
				mrnas.length = 0;
				existingProts = existingProts.concat(newProts);
				newProts.length = 0;
				parameters.protein_bursts.burstRNA = 0;
				delayRNA = 11;
				delayProt = 6;
			}

			for (i=0; i < existingProts.length; ++i) {
				moveDiffusableMolecule(existingProts[i]);
			}

			for (i=0; i < newProts.length; ++i) {
				moveDiffusableMolecule(newProts[i]);
			}
		}
		return {tick:tick, input:null, output:null};
	}

	function init() {

		// create a new stage and point it at our canvas:
		stage = new createjs.Stage(document.getElementById("testCanvas"));
		var rect1 = {left:0, top:0, width: stage.canvas.width, height: stage.canvas.height};
		var rect2 = {left:0, top:stage.canvas.width/2, width: stage.canvas.width, height: stage.canvas.height/2};

		//parameters
		parameters.two_component = {percentActiveMembranes: 0};
		parameters.protein_bursts = {burstRNA:0, burstProt:0, location:{x:0,y:(rect2.top + rect2.height/2)}};
		parameters.sbol = { left: 100 };

		createjs.Ticker.timingMode = createjs.Ticker.RAF;
		createjs.Ticker.addEventListener("tick", stage);

		var modules = [
			lipid_bilayer(stage, rect1),
			dna_template(stage, rect2),
			two_component(stage, rect1),
			protein_bursts(stage, rect1),
			sbol_parts(stage, rect2)
		];

		for (var i=0; i < modules.length; ++i) {
			if (modules[i]) {
				createjs.Ticker.addEventListener("tick", modules[i].tick);
			}
		}

		
	}

</script>
</head>

<body onload="init();">

<div>
	<canvas id="testCanvas" width="1000" height="800"></canvas>
</div>
</body>
</html>
